<?php
define('ROOT', dirname(__FILE__, 2));
require_once(ROOT . '/controllers/Autoloader.php');
new \Controllers\Autoloader('api');

ini_set('memory_limit', '1G');

$getOptions = getopt(null, ["id:"]);

/**
 *  Check if CVE Id is specified
 */
if (empty($getOptions['id'])) {
    echo "Error: CVE name Id must be specified." . PHP_EOL;
    exit(1);
}

/**
 *  Check if CVE Id is numeric
 */
if (!is_numeric($getOptions['id'])) {
    echo "Error: CVE name Id must be numeric." . PHP_EOL;
    exit(1);
}

/**
 *  Get CVE Id
 */
$cveId = $getOptions['id'];

touch(CVE_IMPORT_HOSTS_DIR . '/cve-' . $cveId . '.running');

try {
    $mycve = new \Controllers\Cve\Cve();
    $mycve->searchAffectedHosts($cveId);
} catch (Exception $e) {
    file_put_contents(CVE_IMPORT_HOSTS_ERROR_LOG, $e->getMessage() . PHP_EOL, FILE_APPEND);
    unlink(CVE_IMPORT_HOSTS_DIR .'/cve-' . $cveId . '.running');
    exit(1);
}

unlink(CVE_IMPORT_HOSTS_DIR . '/cve-' . $cveId . '.running');

echo "Done.";

exit;
